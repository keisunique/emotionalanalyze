<!--_meta 作为公共模版分离出去-->
<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="renderer" content="webkit|ie-comp|ie-stand">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
		<meta http-equiv="Cache-Control" content="no-siteapp" />
		<link rel="Bookmark" href="favicon.ico" >
		<link rel="Shortcut Icon" href="favicon.ico" />
		<!--[if lt IE 9]>
		<script type="text/javascript" src="ui/lib/html5.js"></script>
		<script type="text/javascript" src="ui/lib/respond.min.js"></script>
		<![endif]-->
		<link rel="stylesheet" type="text/css" href="/flowvisualization/ui/static/h-ui/css/H-ui.min.css" />
		<link rel="stylesheet" type="text/css" href="/flowvisualization/ui/static/h-ui.admin/css/H-ui.admin.css" />
		<link rel="stylesheet" type="text/css" href="/flowvisualization/ui/lib/Hui-iconfont/1.0.8/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="/flowvisualization/ui/static/h-ui.admin/skin/default/skin.css" id="skin" />
		<link rel="stylesheet" type="text/css" href="/flowvisualization/ui/static/h-ui.admin/css/style.css" />
		<link rel="stylesheet" type="text/css" href="/flowvisualization/js/jquery-ui.css" />	
		<link rel="stylesheet" type="text/css" href="/flowvisualization/ui/lib/layui/css/layui.css">
		<!--[if IE 6]> 
		<script type="text/javascript" src="http://lib.h-ui.net/DD_belatedPNG_0.0.8a-min.js" ></script>
		<script>DD_belatedPNG.fix('*');</script><![endif]-->
		<!--/meta 作为公共模版分离出去--> 
		<title>节点告警设置</title>
		
	</head>
<body>
<!--_header 作为公共模版分离出去-->
<header class="navbar-wrapper">
	<div class="navbar navbar-fixed-top">
		<div class="container-fluid cl"> <a class="logo navbar-logo f-l mr-10 hidden-xs" >VCMY 流量可视化</a>  <span class="logo navbar-slogan f-l mr-10 hidden-xs">v1.3</span>
			<nav style="display:none" class="nav navbar-nav">
				<ul class="cl">
					<li class="dropDown dropDown_hover"><a href="javascript:;" class="dropDown_A"><i class="Hui-iconfont">&#xe600;</i> 新增 <i class="Hui-iconfont">&#xe6d5;</i></a>
						<ul class="dropDown-menu menu radius box-shadow">
							<li><a href="javascript:;" onclick="article_add('添加资讯','article-add.html')"><i class="Hui-iconfont">&#xe616;</i> 资讯</a></li>
							<li><a href="javascript:;" onclick="picture_add('添加资讯','picture-add.html')"><i class="Hui-iconfont">&#xe613;</i> 图片</a></li>
							<li><a href="javascript:;" onclick="product_add('添加资讯','product-add.html')"><i class="Hui-iconfont">&#xe620;</i> 产品</a></li>
							<li><a href="javascript:;" onclick="member_add('添加用户','member-add.html','','510')"><i class="Hui-iconfont">&#xe60d;</i> 用户</a></li>
						</ul>
					</li>
				</ul>
			</nav>
			<nav id="Hui-userbar" style="display:none" class="nav navbar-nav navbar-userbar hidden-xs">
				<ul class="cl">
					<li>超级管理员</li>
					<li class="dropDown dropDown_hover"> <a href="#" class="dropDown_A">admin <i class="Hui-iconfont">&#xe6d5;</i></a>
						<ul class="dropDown-menu menu radius box-shadow">
							<li><a href="javascript:;" onClick="myselfinfo()">个人信息</a></li>
							<li><a href="#">切换账户</a></li>
							<li><a href="#">退出</a></li>
						</ul>
					</li>
					<li id="Hui-msg"> <a href="#" title="消息"><span class="badge badge-danger"></span><i class="Hui-iconfont" style="font-size:18px">&#xe68a;</i></a> </li>
					<li id="Hui-skin" class="dropDown right dropDown_hover"> <a href="javascript:;" class="dropDown_A" title="换肤"><i class="Hui-iconfont" style="font-size:18px">&#xe62a;</i></a>
						<ul class="dropDown-menu menu radius box-shadow">
							<li><a href="javascript:;" data-val="default" title="默认（蓝色）">默认（蓝色）</a></li>
							<li><a href="javascript:;" data-val="black" title="黑色">黑色</a></li>
							<li><a href="javascript:;" data-val="green" title="绿色">绿色</a></li>
							<li><a href="javascript:;" data-val="red" title="红色">红色</a></li>
							<li><a href="javascript:;" data-val="yellow" title="黄色">黄色</a></li>
							<li><a href="javascript:;" data-val="orange" title="橙色">橙色</a></li>
						</ul>
					</li>
				</ul>
			</nav>
		</div>
	</div>
</header>
<!--/_header 作为公共模版分离出去-->

<!--_menu 作为公共模版分离出去-->
<aside class="Hui-aside">
	
	<div class="menu_dropdown bk_2">
		<dl id="flow-analysis">
			<dt><i class="Hui-iconfont">&#xe616;</i> 流量分析<i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i></dt>
			<dd>
				<ul>
					<li><a href="/flowvisualization/analysis/flow" title="节点分析">节点分析</a></li>
					<li><a href="/flowvisualization/analysis/flowinter" title="端口分析">端口分析</a></li>
					<li><a href="/flowvisualization/analysis/topip" title="TOP节点">TOP节点</a></li>
				</ul>
			</dd>
		</dl>
	
		<dl id="menu-article">
			<dt><i class="Hui-iconfont">&#xe616;</i> 流量监控<i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i></dt>
			<dd>
				<ul>
					<li><a href="/flowvisualization/agentFlow" title="节点监控">节点监控</a></li>
					<li><a href="/flowvisualization/InterfacesFlow" title="端口监控">端口监控</a></li>
					<li><a href="/flowvisualization/TopFlow1" title="Top flow">Top流</a></li>
					<li><a href="/flowvisualization/FlowTrace1" title="流跟踪">流跟踪</a></li>
				</ul>
			</dd>
		</dl>
		
		<dl id="menu-picture">
			<dt><i class="Hui-iconfont">&#xe613;</i> 告警设置<i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i></dt>
			<dd style="display: block;">
				<ul>
					<li><a href="/flowvisualization/agentAlarm" title="节点告警">节点告警</a></li>
					<li><a href="/flowvisualization/portAlarm" title="端口告警">端口告警</a></li>
					<li><a href="/flowvisualization/alarmlog" title="告警日志">告警日志</a></li>
				</ul>
			</dd>
		</dl>
		
		<dl id="menu-product">
			<dt><i class="Hui-iconfont">&#xe620;</i> 报表设置<i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i></dt>
			<dd>
				<ul>
					<li><a href="/flowvisualization/reportformstimely" title="即时报表">即时报表</a></li>
					<li><a href="/flowvisualization/reportformsplan" title="计划报表">计划报表</a></li>	
					<li><a href="/flowvisualization/reportformsmsg" title="报表信息">报表信息</a></li>
				</ul>
			</dd>
		</dl>

		
		<dl id="menu-system">
			<dt><i class="Hui-iconfont">&#xe62e;</i> 系统管理<i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i></dt>
			<dd>
				<ul>
					<li><a href="/flowvisualization/system/" title="系统设置">系统信息</a></li>
					<li><a href="/flowvisualization/system/agentlist" title="节点列表">节点列表</a></li>
				</ul>
			</dd>
		</dl>
		
	</div>
	
</aside>
<div class="dislpayArrow hidden-xs"><a class="pngfix" href="javascript:void(0);" onClick="displaynavbar(this)"></a></div>
<!--/_menu 作为公共模版分离出去-->

<section class="Hui-article-box">
	<nav class="breadcrumb"><i class="Hui-iconfont">&#xe67f;</i> <a href="/flowvisualization/home">首页</a><span class="c-gray en">&gt;</span> 告警设置 <span class="c-gray en">&gt;</span> 节点告警<a id="refresh" class="btn btn-success radius r" style="line-height:1.6em;margin-top:3px" href="javascript:location.replace(location.href);" title="刷新" ><i class="Hui-iconfont">&#xe68f;</i></a></nav>
	<div class="Hui-article">
		<article class="cl pd-20">
			<div class="text-c">
				节点IP: 
				<span class="select-box radius" style="width:15%;">
				  <select id="agentIp" name="agentIp" class="select" size="1" name="demo1">
				    <option value="" selected>请选择节点IP</option>
				  </select>
				</span> 
				日期范围:
				<input type="text" id="starttime" name="startTime" class="input-text Wdate radius" style="width:18%;">
				-
				<input type="text" id="endtime" name="endTime" class="input-text Wdate radius" style="width:18%;">
				<button type="submit" onclick="searchAlarm()"  class="btn btn-success radius" id="" name=""><i class="Hui-iconfont">&#xe665;</i> 检索</button>
			</div>
			<div class="cl pd-5 bg-1 bk-gray mt-20"> 
				<span class="l"><a style="display:none" href="javascript:;" onclick="datadel()" class="btn btn-danger radius"><i class="Hui-iconfont">&#xe6e2;</i> 批量删除</a> <a href="javascript:;" onclick="member_add('添加计划','addalarmagent','','510')" class="btn btn-primary radius"><i class="Hui-iconfont">&#xe600;</i> 添加计划</a></span> <span class="r">共有数据：<strong id="dataCount">0</strong> 条</span> </div>
			<div class="mt-20">
				<table class="table table-border table-bordered table-hover table-bg ">
					<thead>
						<tr class="text-c">
							<!-- <th width="25"><input type="checkbox" name="" value=""></th> -->
							<th width="80">名称</th>
							<th width="80">节点IP</th>
							<th width="40">分类</th>
							<th width="40">等级</th>
							<th width="95">开始时间</th>
							<th width="95">结束时间</th>
							<th width="60">阈值</th>
							<th width="40">时间桶</th>
							<th width="70">状态</th>
							<th width="100">操作</th>
						</tr>
					</thead>
					<tbody id="tb">
					
						<tr class="text-c" style="display:none;">
							<td><input type="checkbox" value="1" name=""></td>				
						</tr>
						
					</tbody>				
				</table>
				<div id="page" class="text-r"></div>
				<p id="editp" style="display:none;"></p>
				<p id="alarmId" style="display:none;"></p>
			</div>
		</article>
	</div>
</section>

<!--_footer 作为公共模版分离出去-->
<script type="text/javascript" src="/flowvisualization/ui/lib/jquery/1.9.1/jquery.min.js"></script> 
<script type="text/javascript" src="/flowvisualization/ui/lib/layer/2.4/layer.js"></script>
<script type="text/javascript" src="/flowvisualization/ui/static/h-ui/js/H-ui.js"></script> 
<script type="text/javascript" src="/flowvisualization/ui/static/h-ui.admin/js/H-ui.admin.page.js"></script>
<script type="text/javascript" src="/flowvisualization/js/laydate/laydate.js"></script> 
<!--/_footer /作为公共模版分离出去-->

<!--请在下方写此页面业务相关的脚本-->
<script type="text/javascript" src="/flowvisualization/ui/lib/My97DatePicker/4.8/WdatePicker.js"></script>
<script type="text/javascript" src="/flowvisualization/ui/lib/datatables/1.10.0/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/flowvisualization/ui/lib/laypage/1.2/laypage.js"></script>
<script type="text/javascript" src="/flowvisualization/ui/lib/layui/layui.all.js"></script>
<script type="text/javascript">

laydate.render({
	  elem: '#starttime'
	  ,type: 'datetime'
	});
laydate.render({
	  elem: '#endtime'
	  ,type: 'datetime'
	});

//分页
function initPage(data){
	layui.use(['laypage', 'layer'], function(){
		var thisData = [];
		$.each(data, function(i, n){       	
         	if(n.port==null){	    
         		thisData.push(n);
         	}
		})
		$('#dataCount').text(thisData.length);
		var laypage = layui.laypage
		 laypage.render({
		    elem: 'page',
		    theme: '#6699ff',
		    layout: ['count', 'prev', 'page', 'next', 'limit', 'skip'],
		    count: thisData.length, //数据总数
		    jump: function(obj){
		    	thisData = thisData.concat().splice(obj.curr*obj.limit - obj.limit, obj.limit);
		    	alarmItem(thisData);
		    }
		});
	});
}
/*告警-编辑*/
function member_edit(url,alarm_name){	
	$("#editp").text(alarm_name);
	layer.open({
		type: 2,
		title: "编辑",
		area: ['600px', '510px'],
		content: url,
	});
}


/*告警-添加*/
function member_add(title,url,w,h){
	layer_show(title,url,w,h);
}
/*告警-查看*/
function member_show(id){
	console.log(id);
	$("#alarmId").text(id);
	layer.open({
		type: 2,
		title: false,
		area: ['420px', '525px'],
		shadeClose: true,
		content: "/flowvisualization/alarmdetail",
	});
}


/*暂停告警计划*/
function alarm_stop(obj,id){
	console.log(id);
	layer.confirm('确认要停用吗？',function(index){
		$.ajax({
			url: "/flowvisualization/pausealarm/"+id,
			type: "GET",
			headers: {
				Accept: "application/json"
			},
			success: function(data,textStatus){
				console.log(data);
				if(data.result=="ok"){
					window.location.reload();
				}else{
					layer.msg(data.result,{icon: 5,time:2000});
				}
			},
			error: function(data,textStatus,errorThrown){
				console.log("error : " +data);
			},			
		})
	});
}

//恢复告警计划
function alarm_resume(obj,id){
	layer.confirm('确认要启动吗？',function(index){
		$.ajax({
			url: "/flowvisualization/resumealarm/"+id,
			type: "GET",
			headers: {
				Accept: "application/json"
			},
			success: function(data,textStatus){
				console.log(data);
				if(data.result=="ok"){
					window.location.reload();
				}else{
					layer.msg('启动失败! '+data.result,{icon: 5,time:2000});
				}
			},
			error: function(data,textStatus,errorThrown){
				console.log("error : " +data);
			},			
		})
	});
}




/*告警-删除*/
function member_del(obj){
	layer.confirm('确认要删除吗？',function(index){
		var id = $(obj).attr("name");
		$.ajax({		
			url: "/flowvisualization/deletealarm/"+id,
			type: "GET",
			headers: {
				Accept: "application/json"
			},
			success: function(data,textStatus){
				console.log(data);
				if(data.result=="ok"){
					layer.msg('已删除!',{icon:1,time:1000});
					$(obj).parents("tr").remove();
				}else{
					layer.msg('删除失败!',{icon:2,time:1000});
				}
				
			},
			error: function(data,textStatus,errorThrown){
				layer.msg('删除失败!',{icon:2,time:1000});
			},			
		})
		
	});
}


function alarmItem(data){
	if(data.length==0){
		return;
	}
	var temp;
	 $.each(data, function(i, n){
		 /* //单选框
			var temp = "<tr class=\"text-c\"> <td><input type=\"checkbox\" name="+n.id+"></td>"; */
			//名称
			temp += "<tr class=\"text-c\"><td><u style=\"cursor:pointer\" class=\"text-primary\" onclick=\"member_show('"+n.id+"')\">"+n.alarm_definition.alarm_name+"</u></td>";
			//agentip
			temp += "<td>"+n.agentip+"</td>";
			//分类
			temp += "<td>"+n.alarm_definition.alarm_classfiy+"</td>";
			//等级
			temp += "<td>"+n.alarm_definition.alarm_level+"</td>";
			//开始时间
			temp += "<td>"+n.alarm_condition.begin_time+"</td>";
			//结束时间
			temp += "<td>"+n.alarm_condition.end_time+"</td>";
			if(n.alarm_condition.compare=="大于"){
				//比较操作，阈值，单位
		    	temp += "<td> >"+n.alarm_condition.value+n.alarm_condition.threshold+"</td>";            	
			}else{
				//比较操作，阈值，单位
		    	temp += "<td> <"+n.alarm_condition.value+n.alarm_condition.threshold+"</td>";
			}
			//时间桶
			temp += "<td>"+n.alarm_condition.timebucket+"</td>";	
			//状态
			if(n.status=="启动"){
				temp += "<td class=\"td-status\"><span class=\"label label-success radius\">已启动</span></td>";	
				temp += "<td class=\"td-manage\"><a style=\"text-decoration:none\" onClick=\"alarm_stop(this,'"+n.id+"')\" href=\"javascript:;\" title=\"暂停\"><i class=\"Hui-iconfont\">&#xe631;</i></a>";
				temp += "<a name="+n.id+" title=\"修改\" href=\"javascript:;\" onclick=\"member_edit('editalarmagent','"+n.id+"')\" class=\"ml-5\" style=\"text-decoration:none\"><i class=\"Hui-iconfont\">&#xe6df;</i></a>";
				temp += "<a name="+n.id+" title=\"删除\" href=\"javascript:;\" onclick=\"member_del(this)\" class=\"ml-5\" style=\"text-decoration:none\"><i class=\"Hui-iconfont\">&#xe6e2;</i></a></td>";
			
			}else if(n.status=="暂停"){
				temp += "<td class=\"td-status\"><span class=\"label label-default radius\">已暂停</span></td>";
				temp += "<td class=\"td-manage\"><a style=\"text-decoration:none\" onClick=\"alarm_resume(this,'"+n.id+"')\" href=\"javascript:;\" title=\"启动\"><i class=\"Hui-iconfont\">&#xe6e1;</i></a>";
				temp += "<a name="+n.id+" title=\"修改\" href=\"javascript:;\" onclick=\"member_edit('editalarmagent','"+n.id+"')\" class=\"ml-5\" style=\"text-decoration:none\"><i class=\"Hui-iconfont\">&#xe6df;</i></a>";
				temp += "<a name="+n.id+" title=\"删除\" href=\"javascript:;\" onclick=\"member_del(this)\" class=\"ml-5\" style=\"text-decoration:none\"><i class=\"Hui-iconfont\">&#xe6e2;</i></a></td>";
			}else{
				temp += "<td class=\"td-status\"><span class=\"label label-default radius\">已停止</span></td>";
				temp += "<td class=\"td-manage\"><a name="+n.id+" title=\"删除\" href=\"javascript:;\" onclick=\"member_del(this)\" class=\"ml-5\" style=\"text-decoration:none\"><i class=\"Hui-iconfont\">&#xe6e2;</i></a></td>";
			} 	
			temp += "</tr>";       
	 })
	   	
   	$("#tb").html(temp);
}


/* <!--告警计划列表-->
var alarmList; */

<!--获取所有告警计划-->
function getDate(){
	$.ajax({	
		url: "/flowvisualization/getalarm",
		type: "GET",
		headers: {
			Accept: "application/json"
		},
		success: function(data,textStatus){
			alarmList = data;
			initPage(data);
		},
		error: function(data,textStatus,errorThrown){
			layer.msg('计划获取失败!',{icon:2,time:1000});
		},			
	})
}


<!--检索告警计划-->
function searchAlarm(){
	var agentIp = $('#agentIp').val();
	var starttime = $('#starttime').val();
	var endtime = $('#endtime').val();
	var s = new Date(starttime).getTime();
	var e = new Date(endtime).getTime();
	if(s>=e){
		layer.msg('结束时间不能早于开始时间 ',{icon: 2,time:1500});
		return;
	}
	if(agentIp==""){
		layer.msg('请选择节点IP! ',{icon: 2,time:1500});
		return;
	}
	$.ajax({	
		url: "/flowvisualization/getalarm",
		type: "GET",
		headers: {
			Accept: "application/json"
		},
		success: function(alarmList,textStatus){
			var alarmItems = [];
			$.each(alarmList, function(i, n){
				if(n.port==null){			
					//比较节点
					if(n.agentip==agentIp){
						if(starttime=="" && endtime==""){
							alarmItems.push(n)
							//$.each()中的continue用return true代替
							return true; 
						}
						//节点相同比开始时间
						if(starttime!=""){
							var b1 = new Date(starttime).getTime();
							var b2 = new Date(n.alarm_condition.begin_time).getTime();
							if(b1<=b2){
								//比较结束时间
								if(endtime==""){
									alarmItems.push(n)
									return true;
								}
								var e1 = new Date(endtime).getTime();
								var e2 = new Date(n.alarm_condition.end_time).getTime();
								if(e2<=e1){
									alarmItems.push(n)
									return true; 
								}
							}else{
								return true;
							}
						}
						//开始时间为空，看结束时间是否为空，不空则查结束时间之前的数据
						if(endtime!=""){
							//到这一步，开始时间条件肯定为空
							var e1 = new Date(endtime).getTime();
							var e2 = new Date(n.alarm_condition.end_time).getTime();
							if(e2<=e1){
								alarmItems.push(n)
							}
						}					
					}
				}			
			});
			if(alarmItems.length==0){
				layer.msg('无符合条件的告警计划! ',{icon: 5,time:1500});
			}else{
				layer.msg("找到"+alarmItems.length+"条计划！",{icon:1,time:1500});
				$('#dataCount').text(alarmItems.length);
				initPage(alarmItems);
			}		
		},
		error: function(data,textStatus,errorThrown){
			layer.msg('计划获取失败!',{icon:2,time:1000});
		},				
	})
	
}



$.ajax({
	url:"/flowvisualization/system/getagentlist",
	success:function(result){
		var str = "<option value=\"\" selected>请选择节点IP</option>";
		result = result.sort();
		for(var i=0;i<result.length;i++){
			str += "<option value="+result[i]+">"+result[i]+"</option>"
		}
		$('#agentIp').html(str);		
	},

});

$(document).ready(function(){  
    getDate();
});  
</script>
<!--/请在上方写此页面业务相关的脚本-->
</body>
</html>